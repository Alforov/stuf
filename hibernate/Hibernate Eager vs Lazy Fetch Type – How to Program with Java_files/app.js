"use strict";var app=angular.module("ProofApp",["app.config","firebase","ngAnimate","angularMoment","ngPostMessage"]);angular.module("app.config",[]).constant("version","1.0.130"),app.controller("AlertCtrl",["$scope","db","config","$q","$params","analytics","$timeout","$interval","gravatar","version",function(e,t,n,o,i,r,a,s,c,u){function l(e){return e.split(/[?#]/)[0]}console.log("Version:",u);var f=function(e,t){t&&(n.session[e]=t)},d=function(e){for(var t=o.defer(),n=0;n<e.length;n++)i[e[n]]||t.reject("Missing required url parameters.");return t.resolve(!0),t.promise},p=function(){var e=o.defer();return n.auth.$onAuthStateChanged(function(t){t?(n.session_id=t.uid,n.session_id=t.uid,e.resolve(t.uid)):(console.log("Starting new session"),n.auth.$signInAnonymously())}),e.promise},m=function(e,t){t&&(n.analytics_event[e]=t)},g=function(){n.pixel_id&&i.url&&(m("type",i.utm_source),m("pixel_id",n.pixel_id),m("url",i.url),m("session_id",n.session_id),m("utm_source",i.utm_source),m("utm_campaign",i.utm_campaign),m("utm_medium",i.utm_medium),m("utm_content",i.utm_content),m("utm_term",i.utm_term),m("ref",i.ref),m("ref_domain",i.ref_domain),m("email",i.email),r.track(n.analytics_event).then(function(e){e&&(f("ip",e.ip),n.session.$save())}))},h=function(){var e=t.getSessionPageviewsRef(n.pixel_id,n.session_id);return e.transaction(function(e){return e+1})},_=function(){var e=t.getPixelStatsPageviewsRef(n.pixel_id);return e.transaction(function(e){return e+1})},v=function(){var e=t.getPixelStatsSessionsRef(n.pixel_id);return e.transaction(function(e){return e+1})},b=function(){return n.session=t.getSession(n.pixel_id,n.session_id),n.session.$loaded().then(function(){return n.session.init?!n.session.email&&i.email?(f("email",i.email),n.session.$save().then(function(){return console.log("Updated session email"),!0})):"Existing session":(f("initial_url",i.url),f("utm_source",i.utm_source),f("utm_campaign",i.utm_campaign),f("utm_medium",i.utm_medium),f("utm_content",i.utm_content),f("ref",i.ref),f("email",i.email),f("utm_term",i.utm_term),f("created",n.startTime),f("init",!0),n.session.$save().then(v).then(function(){return console.log("Updated session data"),!0}))})},$=function(){console.log("Pixel:",i.acc);var e=o.defer();return n.pixel=t.getPixel(i.acc),n.pixel.$loaded().then(function(){n.pixel.active?n.pixel.init?e.resolve(n.pixel):e.reject("Invalid Proof tracking pixel."):e.reject("Pixel is not active. Please reactivate your Proof account to enable.")}),e.promise},y=function(){var e=t.getProofUrls(i.acc);return e.$loaded().then(function(){return e})},w=function(e){for(var t=0;t<e.length;t++){if(e[t].active){var n=i.url.toLowerCase(),o=e[t].match.toLowerCase();switch(e[t].match_type){case"equals":if(l(n)==o)return e[t].$id;break;case"contains":if(n.includes(o))return e[t].$id;break;case"startswith":if(n.startsWith(o))return e[t].$id;break;case"endswith":if(n.endsWith(o))return e[t].$id;break;default:return{error:"Invalid URL match type."}}}if(t==e.length-1)return{error:"URL does not match any Proofs"}}return{error:"Pixel does not have any active proofs"}},P=function(){var e=o.defer();return y().then(function(t){var n=w(t);n.error?e.reject(n.error):e.resolve(n)}),e.promise},x=function(e){return m("proof_id",e),n.proof_id=e,n.selectedProof=t.getProof(n.pixel_id,e),n.selectedProof.$loaded().then(function(){return n.selectedProof.integration_id})},k=function(i){var r=o.defer();return"auto"==n.selectedProof.integration_type?(m("integration_id",n.proof_id),m("integration_type","auto"),n.integration_id=n.proof_id,e.proofs=t.getProofs(n.pixel_id,n.proof_id),e.proofs.$loaded().then(function(){e.proofs=e.proofs.slice().reverse(),r.resolve()})):i?(m("integration_id",i),m("integration_type",n.selectedProof.integration_type||"clickfunnels"),n.integration_id=i,e.proofs=t.getProofs(n.pixel_id,i),e.proofs.$loaded().then(function(){e.proofs=e.proofs.slice().reverse(),r.resolve()})):r.reject("Missing integration id"),r.promise},S=function(t,o){C(n.count),t=t||8,o=o||3,s(function(){e.hideNotication(),a(function(){C(n.count)},1e3*o)},1e3*(t+2))},C=function(t){e.proofs.length&&(e.proofs[t]?e.proof.new(e.proofs[t]):(n.count=0,t=0,e.proof.new(e.proofs[t])),e.$emit("$messageOutgoing",angular.toJson({state:"show"})),n.count++)};e.hideNotication=function(){e.$emit("$messageOutgoing",angular.toJson({state:"hide"}))},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},e.proof={"new":function(t){t&&n.selectedProof.action_blurb&&(e.proof.who=(t.first_name||"Someone").capitalize(),t.city&&(e.proof.where="from "+t.city.capitalize()),t.state&&(e.proof.where?e.proof.where+=", "+t.state.capitalize():e.proof.where="from "+t.state.capitalize()),e.proof.what=n.selectedProof.action_blurb.capitalize(),e.proof.when=t.timestamp,e.proof.img=t.photo||t.img||c(t.hash,t.default_img))}},d(n.requiredParams).then(p).then(b).then(h).then($).then(_).then(P).then(x).then(k).then(function(){n.endTime=(new Date).getTime(),console.log("Time to complete:",(n.endTime-n.startTime)/1e3,"seconds"),g(),e.proofs.length||console.log("Waiting for new proofs..."),e.poweredByLinkParams=["?utm_source=",encodeURIComponent(i.url),"&utm_campaign=","widget-referral","&utm_term=",n.pixel_id,"&utm_content=",n.session_id].join(""),S(7,3)}).catch(function(e){g(),console.debug("ERROR:",e)})}]),app.controller("SyncCtrl",["$scope","db","config","isValid","$params",function(e,t,n,o,i){function r(e){return e.split(/[?#]/)[0]}function a(){e.$root.$on("$messageIncoming",function(e,t){function a(e){return/\d{3}/.test(e)}function u(e){return!isNaN(parseFloat(e))&&isFinite(e)}function l(e){return e=e.split(""),e.reduce(function(e,t){return u(t)?e+1:e},0)}const f=function(e){return e.replace(/[^a-zA-Z0-9]/g,"_")};switch(t.job_type){case"sync":("email"==t.type&&o.email(t.value)||"email"==t.name&&o.email(t.value))&&(s.email=t.value),s.form_data=s.form_data||{},s.form_data[f(t.name)]={name:t.name,type:t.type,value:t.value};var d=t.value;!a(d)&&l(d)<8||(console.log("Sanitized"),delete s.form_data[f(t.name)]);break;case"submit":if(console.log("submit..."),!s.email){console.log("No email found");var p=s.form_data;for(var m in p)if(p.hasOwnProperty(m)&&o.email(p[m].value)){s.email=p[m].value;break}}if(s.email&&o.email(s.email)){s.conversions=s.conversions||{};var g=s.email.replace("@","_at_").replace(/\./g,"_dot_");s.conversions[g]=s.conversions[g]||{},s.pageUrl=r(i.url);var h=s.pageUrl.hashCode();if(!s.conversions[g][h]){s.conversions[g][h]=!0,delete s.form_data,s.$save().catch(function(e){console.log(e)}).then(function(){console.log("Session:",c)});var t={pixel_id:n.pixel_id,session_id:c,lead:s};n.selectedProof&&(t.proof_id=n.selectedProof.$id),n.worker_queue.$add(t).then(function(){console.log("Conversion tracked")}).catch(function(e){console.log(e)})}}}})}var s,c;n.auth.$onAuthStateChanged(function(e){e&&(n.worker_queue=t.getWorkerQueue(),c=e.uid,s=t.getSession(n.pixel_id,c),s.$loaded().then(function(){a()}))}),String.prototype.hashCode=function(){var e=0;if(0==this.length)return e;for(var t=0;t<this.length;t++){var n=this.charCodeAt(t);e=(e<<5)-e+n,e&=e}return 0>e&&(e=-1*e),e}}]),app.factory("analytics",["$http","$q",function(e,t){return{track:function(n){var o=t.defer();if(n.type,n.pixel_id){var i="https://analytics.proofapi.com/track";e.post(i,n).success(function(e){o.resolve(e)}).error(function(e){console.debug("Analytics error:",e),o.resolve(e)})}else console.debug("Missing required analytics tracking parameters"),o.resolve({err:"Missing required analytics tracking parameters"});return o.promise}}}]),app.factory("config",["$params","$firebaseAuth",function(e,t){return{count:0,pixel_id:e.acc,requiredParams:["url","acc"],auth:t(),startTime:(new Date).getTime(),analytics_event:{}}}]),app.factory("db",["$firebaseObject","$firebaseArray",function(e,t){function n(t,n){var o=firebase.database().ref("sessions").child(t).child(n);return e(o)}function o(t){var n=firebase.database().ref("pixels").child(t);return e(n)}function i(e){var n=firebase.database().ref("pixels").child(e).child("proofs");return t(n)}function r(t,n){var o=firebase.database().ref("proofs").child(t).child(n);return e(o)}function a(e,n){var o=firebase.database().ref("notifications").child(e).child(n).orderByChild("timestamp").limitToLast(20);return t(o)}function s(){var e=firebase.database().ref("worker_queue/new_leads/tasks").limitToLast(1).equalTo(1);return t(e)}function c(e,t){return firebase.database().ref().child("sessions").child(e).child(t).child("pageviews")}function u(e){return firebase.database().ref().child("pixel_stats").child(e).child("pageviews")}function l(e){return firebase.database().ref().child("pixel_stats").child(e).child("sessions")}return{getSession:n,getPixel:o,getProofUrls:i,getProof:r,getProofs:a,getWorkerQueue:s,getSessionPageviewsRef:c,getPixelStatsPageviewsRef:u,getPixelStatsSessionsRef:l}}]),app.factory("gravatar",function(){return function(e,t){if(!t)var t="https://speed-loader.s3.amazonaws.com/nFjBt_alert.png";return e?"https://www.gravatar.com/avatar/"+e+"?d="+encodeURIComponent(t):"assets/img/icon.png"}}),app.factory("$params",function(){var e=function(){for(var e={},t=window.location.search.substring(1),n=t.split("&"),o=0;o<n.length;o++){var i=n[o].split("=");if("undefined"==typeof e[i[0]])e[i[0]]=decodeURIComponent(i[1]);else if("string"==typeof e[i[0]]){var r=[e[i[0]],decodeURIComponent(i[1])];e[i[0]]=r}else e[i[0]].push(decodeURIComponent(i[1]))}return e}();return e}),app.factory("isValid",["$params","$firebaseAuth",function(){function e(e){return e.replace(/^\s+|\s+$/,"")}function t(t){if(t){var n=e(t),o=/^[^@]+@[^@.]+\.[^@]*\w\w$/,i=/[\(\)\<\>\,\;\:\\\"\[\]]/;return""==t?!1:o.test(n)?t.match(i)?!1:!0:!1}return!1}return{email:t}}]);